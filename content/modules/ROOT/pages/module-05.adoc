= Bring your Custom MCP Servers into OpenShift Lightspeed

OpenShift Lightspeed can be extended beyond its built-in capabilities by integrating custom MCP servers. This feature allows you to add additional MCP servers that provide new tools to the OpenShift Lightspeed instance, enabling the LLM to use these external tools when generating answers to your questions. 

NOTE: This is currently a Technology Preview feature of OpenShift Lightspeed.

In this module, you'll deploy the Insights Result MCP server that connects to Red Hat Insights and provides two tools:

* _get_last_result_for_cluster:_ returns a dictionary with the cluster result.
* _get_upgrade_risk_prediction_for_cluster:_ returns a dictionary with the upgrade risks prediction for the given cluster.

[#deploy-the-insights-result-mcp-server]
== Deploy the Insights Result MCP server

OpenShift Lightspeed can connect to MCP servers running outside the cluster, but in this case, the Insights Result MCP server will be deployed directly within our OpenShift cluster.

In order to deploy the MCP server, we will need to create several resources in our cluster. Some of them will be created via YAML in the OpenShift Dashboard, while others that require environment variables will be created from the Command Line.

Let's prepare the Web console to easily apply all the resources. In the upper-right corner menu, click on the *OpenShift command line* option.

image::command-line.png[OpenShift Command Line menu, 50%]

This will open a new tab at the bottom of your page. There, select *Start*. 

In the same upper-right menu, you can spot the *Quick create* button, where we will be able to Import the _Project_, _Deployment_ and _Service_ YAML resources:

image::import-yaml.png[OpenShift Import YAML menu, 50%]

=== Deploy the Project:

Start by creating the _Project_. Click on *Quick create* > *Import YAML* in the top-right corner. Then, paste the following YAML and click *Create*:

[source,yaml,role="execute",subs=attributes+]
----
apiVersion: project.openshift.io/v1
kind: Project
metadata:
  labels:
    kubernetes.io/metadata.name: insights-results-mcp
  name: insights-results-mcp
----

=== Create the secret:

The _Secret_ needs to include our cluster's pull secret. To dynamically generate this resource and inject that value, run the following command in your Terminal at the bottom:

[source,role="execute",subs=attributes+]
----
oc create -n insights-results-mcp secret generic insights-results-secret \
  --from-literal=CONSOLE_REDHAT_PULL_SECRET="$(oc get secrets pull-secret -n openshift-config -o json | jq -r '.data.".dockerconfigjson"' | base64 -d | jq -r '.auths."cloud.openshift.com".auth')"
----

=== Create the ConfigMap:

Similar to what we did with the Secret, run the following command to generate the _ConfigMap_ that includes our cluster's ID:

[source,role="execute",subs=attributes+]
----
oc create -n insights-results-mcp configmap cluster-info \
  --from-literal=CLUSTER_ID="$(oc get clusterversion -o jsonpath='{.items[].spec.clusterID}')"
----

That's the last resource we will create using the command line, so you can close the Terminal window at the bottom.

=== Generate Deployment:

Now, let's go back to the YAML creation procedure. To create the _Deployment_, navigate to *Quick create* > *Import YAML* in the top-right corner and then paste the following YAML before clicking *Create*:

[source,yaml,role="execute",subs=attributes+]
----
apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    name: insights-results-mcp
  name: insights-results-mcp-server
  namespace: insights-results-mcp
spec:
  replicas: 1
  selector:
    matchLabels:
      app: insights-results-mcp-server
  template:
    metadata:
      labels:
        app: insights-results-mcp-server
    spec:
      containers:
      - env:
        - name: TRANSPORT
          value: streamable-http
        - name: CLUSTER_ID
          valueFrom:
            configMapKeyRef:
              name: cluster-info
              key: CLUSTER_ID
        - name: CLIENT_SECRET
          valueFrom:
            secretKeyRef:
              name: insights-results-secret
              key: CONSOLE_REDHAT_PULL_SECRET
        image: quay.io/joseluis/insights-results-mcp:latest
        imagePullPolicy: Always
        name: container
        ports:
        - containerPort: 5000
          protocol: TCP
          name: mcp
        resources: {}
        terminationMessagePath: /dev/termination-log
        terminationMessagePolicy: File
      dnsPolicy: ClusterFirst
      restartPolicy: Always
      schedulerName: default-scheduler
      securityContext: {}
      terminationGracePeriodSeconds: 30
----

In the Web Console interface, you will see a Pod being created and Running after a few seconds.

=== Generate Service:

Finally, create the _Service_ to expose the MCP url. Again, click on *Quick create* > *Import YAML*. There, copy the contents of the following YAML and press *Create*.

[source,yaml,role="execute",subs=attributes+]
----
apiVersion: v1
kind: Service
metadata:
  labels:
    app.kubernetes.io/name: insights-results-mcp
  name: insights-results-mcp-server
  namespace: insights-results-mcp
spec:
  internalTrafficPolicy: Cluster
  ipFamilies:
  - IPv4
  ipFamilyPolicy: SingleStack
  ports:
  - name: mcp
    port: 5000
    protocol: TCP
    targetPort: mcp
  selector:
    app: insights-results-mcp-server
  sessionAffinity: None
  type: ClusterIP
----

The Insights Result MCP server is now configured and running in our cluster. It's time to connect it to our OpenShift Lightspeed instance. 

[#configure-openshift-lightspeed]
== Configure Openshift Lightspeed

As we have seen in previous sections, the configuration in our OpenShift Lightspeed operator needs to be done in the OLSConfig resource. 

Navigate to *Ecosystem* and then *Installed Operators* in the left hand menu, and make sure you select *Project: All Projects* to list all the operators in the cluster. 

Click the *OpenShift Lightspeed Operator* and navigate to the *OLSConfig* tab. Then click on the `cluster` instance. Finally, select the *YAML* tab.

Once in the OLSConfig YAML resource, add the following lines and click *Save*:

[source,yaml,role="execute",subs=attributes+]
----
...
spec:
...
  llm:
...
  featureGates:
    - MCPServer
  mcpServers:
    - name: insights-results-mcp
      streamableHTTP:
        enableSSE: false
        sseReadTimeout: 10
        timeout: 5
        url: 'http://insights-results-mcp-server.insights-results-mcp.svc.cluster.local:5000/api/insights-results-mcp'
----

This new configuration will re-deploy the OpenShift Lightspeed app server pod. Please wait a minute before starting to interact with OpenShift Lightspeed.

[#use-your-custom-mcp-server]
== Use your custom MCP server

Now try asking OpenShift Lightspeed the following question about your Insights inventory. The model should use one of the tools that the new MCP server provides: 

[source,role="execute",subs=attributes+]
----
Show me the systems in my Insights inventory
----

It's likely that the LLM has decided to use the _get_last_result_for_cluster_ tool provided by the Insights Result MCP server. Since the cluster should be healthy, the response will probably indicate that there are no issues listed. This doesn't mean the tool call failedâ€”quite the opposite! The tool successfully retrieved that information from Insights.

== Lightspeed Beyond Containers

So far, we've explored how OpenShift Lightspeed helps with traditional containerized workloads like pods, deployments, routes, and services. But OpenShift is more than just containers. What about virtual machines?

With OpenShift Virtualization, you can run virtual machines alongside your containers on the same OpenShift platform. And here's the interesting part: at the end of the day, virtual machines in OpenShift are just OpenShift custom resources. This means OpenShift Lightspeed can help you with your virtual machine workloads too. Whether you need to understand VM networking, troubleshoot a VM that won't start, or generate YAML for a new virtual machine configuration, OpenShift Lightspeed has the knowledge to assist you.